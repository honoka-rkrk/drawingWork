{"ast":null,"code":"import _regeneratorRuntime from\"/Users/rakuraku2563/Desktop/drawingWork/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/rakuraku2563/Desktop/drawingWork/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/rakuraku2563/Desktop/drawingWork/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useRef,useState}from'react';import firebase from'firebase/app';import'firebase/auth';import'firebase/firestore';import{FirebaseContext,UserContext}from'./Context/contexts';import findUser from'./Functions/find-user';import writeUser from'./Functions/write-user';import{jsx as _jsx}from\"react/jsx-runtime\";var FirebaseApp=function FirebaseApp(_ref){var children=_ref.children;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),user=_useState2[0],setUser=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),credential=_useState4[0],setCredential=_useState4[1];var counterRef=useRef(0);var auth=firebase.auth();var db=firebase.firestore();//認証状態が変更されたときに引数として渡されたトリガー関数が実行されるオブザーバー\nvar unsubscribe=auth.onAuthStateChanged(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(firebaseUser){var theUser,_theUser;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!firebaseUser){_context.next=15;break;}if(!(counterRef.current===1&&credential)){_context.next=8;break;}_context.next=4;return writeUser(db,firebaseUser,credential);case 4:theUser=_context.sent;setUser(theUser);_context.next=13;break;case 8:if(user){_context.next=13;break;}_context.next=11;return findUser(db,firebaseUser.uid);case 11:_theUser=_context.sent;setUser(_theUser);case 13:_context.next=16;break;case 15:setUser(null);case 16:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref2.apply(this,arguments);};}());useEffect(function(){if(credential)counterRef.current+=1;return unsubscribe;});return/*#__PURE__*/_jsx(FirebaseContext.Provider,{value:{auth:auth,db:db},children:/*#__PURE__*/_jsx(UserContext.Provider,{value:{user:user,credential:credential,setCredential:setCredential},children:children})});};export default FirebaseApp;","map":{"version":3,"sources":["/Users/rakuraku2563/Desktop/drawingWork/src/FirebaseApp.tsx"],"names":["React","useEffect","useRef","useState","firebase","FirebaseContext","UserContext","findUser","writeUser","FirebaseApp","children","user","setUser","credential","setCredential","counterRef","auth","db","firestore","unsubscribe","onAuthStateChanged","firebaseUser","current","theUser","uid"],"mappings":"udAAA,MAAOA,CAAAA,KAAP,EAAoBC,SAApB,CAA+BC,MAA/B,CAAuCC,QAAvC,KAAuD,OAAvD,CACA,MAAOC,CAAAA,QAAP,KAAqB,cAArB,CACA,MAAO,eAAP,CACA,MAAO,oBAAP,CAGA,OAASC,eAAT,CAA0BC,WAA1B,KAA6C,oBAA7C,CACA,MAAOC,CAAAA,QAAP,KAAqB,uBAArB,CACA,MAAOC,CAAAA,SAAP,KAAsB,wBAAtB,C,2CAEA,GAAMC,CAAAA,WAAe,CAAG,QAAlBA,CAAAA,WAAkB,MAAkB,IAAfC,CAAAA,QAAe,MAAfA,QAAe,CACxC,cAAwBP,QAAQ,CAAc,IAAd,CAAhC,wCAAOQ,IAAP,eAAaC,OAAb,eACA,eAAoCT,QAAQ,CAC1C,IAD0C,CAA5C,yCAAOU,UAAP,eAAmBC,aAAnB,eAGA,GAAMC,CAAAA,UAAU,CAAGb,MAAM,CAAS,CAAT,CAAzB,CACA,GAAMc,CAAAA,IAAI,CAAGZ,QAAQ,CAACY,IAAT,EAAb,CACA,GAAMC,CAAAA,EAAE,CAAGb,QAAQ,CAACc,SAAT,EAAX,CAEA;AACA,GAAMC,CAAAA,WAAW,CAAGH,IAAI,CAACI,kBAAL,2FAAwB,iBAAOC,YAAP,2IACtCA,YADsC,+BAEpCN,UAAU,CAACO,OAAX,GAAuB,CAAvB,EAA4BT,UAFQ,gDAGhBL,CAAAA,SAAS,CAACS,EAAD,CAAKI,YAAL,CAAmBR,UAAnB,CAHO,QAGhCU,OAHgC,eAItCX,OAAO,CAACW,OAAD,CAAP,CAJsC,iCAK5BZ,IAL4B,iDAMhBJ,CAAAA,QAAQ,CAACU,EAAD,CAAKI,YAAY,CAACG,GAAlB,CANQ,SAMhCD,QANgC,eAOtCX,OAAO,CAACW,QAAD,CAAP,CAPsC,uCAUxCX,OAAO,CAAC,IAAD,CAAP,CAVwC,uDAAxB,gEAApB,CAcAX,SAAS,CAAC,UAAM,CACd,GAAIY,UAAJ,CAAgBE,UAAU,CAACO,OAAX,EAAsB,CAAtB,CAEhB,MAAOH,CAAAA,WAAP,CACD,CAJQ,CAAT,CAMA,mBACE,KAAC,eAAD,CAAiB,QAAjB,EAA0B,KAAK,CAAE,CAAEH,IAAI,CAAJA,IAAF,CAAQC,EAAE,CAAFA,EAAR,CAAjC,uBACE,KAAC,WAAD,CAAa,QAAb,EAAsB,KAAK,CAAE,CAAEN,IAAI,CAAJA,IAAF,CAAQE,UAAU,CAAVA,UAAR,CAAoBC,aAAa,CAAbA,aAApB,CAA7B,UACGJ,QADH,EADF,EADF,CAOD,CArCD,CAuCA,cAAeD,CAAAA,WAAf","sourcesContent":["import React, { FC, useEffect, useRef, useState } from 'react';\nimport firebase from 'firebase/app';\nimport 'firebase/auth';\nimport 'firebase/firestore';\n\nimport { User } from './Model/user';\nimport { FirebaseContext, UserContext } from './Context/contexts';\nimport findUser from './Functions/find-user';\nimport writeUser from './Functions/write-user';\n\nconst FirebaseApp: FC = ({ children }) => {\n  const [user, setUser] = useState<User | null>(null);\n  const [credential, setCredential] = useState<firebase.auth.UserCredential | null>(\n    null\n  );\n  const counterRef = useRef<number>(0);\n  const auth = firebase.auth();\n  const db = firebase.firestore();\n\n  //認証状態が変更されたときに引数として渡されたトリガー関数が実行されるオブザーバー\n  const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {\n    if (firebaseUser) {\n      if (counterRef.current === 1 && credential) {\n        const theUser = await writeUser(db, firebaseUser, credential);\n        setUser(theUser);\n      } else if (!user) {\n        const theUser = await findUser(db, firebaseUser.uid);\n        setUser(theUser);\n      }\n    } else {\n      setUser(null);\n    }\n  });\n\n  useEffect(() => {\n    if (credential) counterRef.current += 1;\n\n    return unsubscribe;\n  });\n\n  return (\n    <FirebaseContext.Provider value={{ auth, db }}>\n      <UserContext.Provider value={{ user, credential, setCredential }}>\n        {children}\n      </UserContext.Provider>\n    </FirebaseContext.Provider>\n  );\n};\n\nexport default FirebaseApp;\n"]},"metadata":{},"sourceType":"module"}