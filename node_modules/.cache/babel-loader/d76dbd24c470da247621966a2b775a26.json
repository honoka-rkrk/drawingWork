{"ast":null,"code":"import _regeneratorRuntime from\"/Users/rakuraku2563/Desktop/drawingWork/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/rakuraku2563/Desktop/drawingWork/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/rakuraku2563/Desktop/drawingWork/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useContext}from'react';import firebase,{db}from'../../firebase';import{collectionName}from'../../Functions/constants';import CompDetailPicture from'../Component/detailPicture';import{UserContext}from'../../Context/contexts';import{jsx as _jsx}from\"react/jsx-runtime\";var DetailPicture=function DetailPicture(props){var image=props.image,favNum=props.favNum,setFavNum=props.setFavNum;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isFav=_useState2[0],setIsFav=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),isDisabled=_useState4[0],setIsDisabled=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),favCount=_useState6[0],setFavCount=_useState6[1];var _useContext=useContext(UserContext),user=_useContext.user;//ボタンの状態変化\nvar handleFavClick=function handleFavClick(){if(isFav){setFavNum(function(prev){return prev+1;});deleteFavorite();}else{setFavNum(function(prev){return prev-1;});postFavorite();}setIsFav(function(prev){return!prev;});};//いいねを追加。カウントも１追加\nvar postFavorite=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var batch,favoriteUsersDoc,favoriteNumDoc;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:batch=db.batch();//ユーザーのスクリーン名とディスプレイネームを追加\nif(!(image.id&&user)){_context.next=8;break;}favoriteUsersDoc=db.collection('images').doc(image.id).collection(collectionName.favoriteUsers).doc(user.screenName);batch.set(favoriteUsersDoc,{user:user.displayName});//全てのいいねの数をカウント\nfavoriteNumDoc=db.collection('images').doc(image.id).collection(collectionName.favoriteNum).doc(collectionName.favCounters);batch.set(favoriteNumDoc,{count:firebase.firestore.FieldValue.increment(1)},{merge:true});_context.next=8;return batch.commit();case 8:case\"end\":return _context.stop();}}},_callee);}));return function postFavorite(){return _ref.apply(this,arguments);};}();//いいねの消去、カウントも１減算\nvar deleteFavorite=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var batch,favoriteUsersDoc,favoriteNumDoc;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:batch=db.batch();if(!(image.id&&user)){_context2.next=8;break;}//ユーザーのスクリーン名とディスプレイネームを消去\nfavoriteUsersDoc=db.collection('images').doc(image.id).collection(collectionName.favoriteUsers).doc(user.screenName);batch.delete(favoriteUsersDoc);favoriteNumDoc=db.collection('images').doc(image.id).collection(collectionName.favoriteNum).doc(collectionName.favCounters);batch.set(favoriteNumDoc,{count:firebase.firestore.FieldValue.increment(-1)},{merge:true});_context2.next=8;return batch.commit();case 8:case\"end\":return _context2.stop();}}},_callee2);}));return function deleteFavorite(){return _ref2.apply(this,arguments);};}();useEffect(function(){var id;var unmounted=false;var getFavCounts=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var favCountsRef;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:favCountsRef=db.collection('images').doc(image.id).collection(collectionName.favoriteNum).doc('favCounters');_context3.next=3;return favCountsRef.get().then(function(doc){var getData=doc.data();if(!unmounted){if(getData){setFavCount(getData.count);}else{setFavCount(0);}}}).catch(function(error){console.log('Error getting document',error);});case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function getFavCounts(){return _ref3.apply(this,arguments);};}();var timer=function timer(){getFavCounts();return window.setTimeout(function(){id=timer();},5000);};id=timer();return function(){unmounted=true;clearTimeout(id);};},[setFavCount]);//いいねできる数の制限がきたら他のボタンを押せなくする\nuseEffect(function(){if(favNum<=0&&!isFav){setIsDisabled(true);}else{setIsDisabled(false);}},[isFav,favNum]);return/*#__PURE__*/_jsx(CompDetailPicture,{image:image,handleFavClick:handleFavClick,isFav:isFav,isDisabled:isDisabled,favCount:favCount});};export default DetailPicture;","map":{"version":3,"sources":["/Users/rakuraku2563/Desktop/drawingWork/src/DispPicture/Container/detailPicture.tsx"],"names":["React","useState","useEffect","useContext","firebase","db","collectionName","CompDetailPicture","UserContext","DetailPicture","props","image","favNum","setFavNum","isFav","setIsFav","isDisabled","setIsDisabled","favCount","setFavCount","user","handleFavClick","prev","deleteFavorite","postFavorite","batch","id","favoriteUsersDoc","collection","doc","favoriteUsers","screenName","set","displayName","favoriteNumDoc","favoriteNum","favCounters","count","firestore","FieldValue","increment","merge","commit","delete","unmounted","getFavCounts","favCountsRef","get","then","getData","data","catch","error","console","log","timer","window","setTimeout","clearTimeout"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useContext } from 'react';\nimport firebase, { db } from '../../firebase';\n\nimport { collectionName } from '../../Functions/constants';\nimport { Image } from '../../Model/image';\nimport CompDetailPicture from '../Component/detailPicture';\nimport { UserContext } from '../../Context/contexts';\n\ntype DetailPictureProps = {\n  image: Image;\n  favNum: number;\n  setFavNum: React.Dispatch<React.SetStateAction<number>>;\n};\nconst DetailPicture: React.FC<DetailPictureProps> = (props: DetailPictureProps) => {\n  const { image, favNum, setFavNum } = props;\n  const [isFav, setIsFav] = useState<boolean>(false);\n  const [isDisabled, setIsDisabled] = useState<boolean>(false);\n  const [favCount, setFavCount] = useState<number>(0);\n  const { user } = useContext(UserContext);\n\n  //ボタンの状態変化\n  const handleFavClick = () => {\n    if (isFav) {\n      setFavNum((prev) => prev + 1);\n      deleteFavorite();\n    } else {\n      setFavNum((prev) => prev - 1);\n      postFavorite();\n    }\n    setIsFav((prev) => !prev);\n  };\n\n  //いいねを追加。カウントも１追加\n  const postFavorite = async () => {\n    const batch = db.batch();\n    //ユーザーのスクリーン名とディスプレイネームを追加\n    if (image.id && user) {\n      const favoriteUsersDoc = db\n        .collection('images')\n        .doc(image.id)\n        .collection(collectionName.favoriteUsers)\n        .doc(user.screenName);\n\n      batch.set(favoriteUsersDoc, {\n        user: user.displayName\n      });\n\n      //全てのいいねの数をカウント\n      const favoriteNumDoc = db\n        .collection('images')\n        .doc(image.id)\n        .collection(collectionName.favoriteNum)\n        .doc(collectionName.favCounters);\n\n      batch.set(\n        favoriteNumDoc,\n        {\n          count: firebase.firestore.FieldValue.increment(1)\n        },\n        {\n          merge: true\n        }\n      );\n      await batch.commit();\n    }\n  };\n\n  //いいねの消去、カウントも１減算\n  const deleteFavorite = async () => {\n    const batch = db.batch();\n    if (image.id && user) {\n      //ユーザーのスクリーン名とディスプレイネームを消去\n      const favoriteUsersDoc = db\n        .collection('images')\n        .doc(image.id)\n        .collection(collectionName.favoriteUsers)\n        .doc(user.screenName);\n      batch.delete(favoriteUsersDoc);\n\n      const favoriteNumDoc = db\n        .collection('images')\n        .doc(image.id)\n        .collection(collectionName.favoriteNum)\n        .doc(collectionName.favCounters);\n\n      batch.set(\n        favoriteNumDoc,\n        {\n          count: firebase.firestore.FieldValue.increment(-1)\n        },\n        {\n          merge: true\n        }\n      );\n      await batch.commit();\n    }\n  };\n\n  useEffect(() => {\n    let id: number;\n    let unmounted = false;\n    const getFavCounts = async () => {\n      const favCountsRef = db\n        .collection('images')\n        .doc(image.id)\n        .collection(collectionName.favoriteNum)\n        .doc('favCounters');\n      await favCountsRef\n        .get()\n        .then((doc) => {\n          const getData: any = doc.data();\n          if (!unmounted) {\n            if (getData) {\n              setFavCount(getData.count);\n            } else {\n              setFavCount(0);\n            }\n          }\n        })\n        .catch((error) => {\n          console.log('Error getting document', error);\n        });\n    };\n    const timer = () => {\n      getFavCounts();\n      return window.setTimeout(() => {\n        id = timer();\n      }, 5000);\n    };\n    id = timer();\n    return () => {\n      unmounted = true;\n      clearTimeout(id);\n    };\n  }, [setFavCount]);\n\n  //いいねできる数の制限がきたら他のボタンを押せなくする\n  useEffect(() => {\n    if (favNum <= 0 && !isFav) {\n      setIsDisabled(true);\n    } else {\n      setIsDisabled(false);\n    }\n  }, [isFav, favNum]);\n\n  return (\n    <CompDetailPicture\n      image={image}\n      handleFavClick={handleFavClick}\n      isFav={isFav}\n      isDisabled={isDisabled}\n      favCount={favCount}\n    />\n  );\n};\n\nexport default DetailPicture;\n"]},"metadata":{},"sourceType":"module"}